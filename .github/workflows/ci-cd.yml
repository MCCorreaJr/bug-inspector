name: CI/CD Bug Inspector

on:
  push:
    branches:
      - dev
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Server Dependencies
        run: npm install
        working-directory: ./server

      - name: Run Server Tests
        run: npm test
        working-directory: ./server

      - name: Install Extension Dependencies
        run: npm install
        working-directory: ./src

      - name: Build Extension
        run: npm run build
        working-directory: ./src

      - name: Upload Server Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bug-inspector-server
          path: ./server
          retention-days: 1

      - name: Upload Extension Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bug-inspector-extension
          path: ./src/dist
          retention-days: 1

  deploy_homol:
    needs: build_and_test
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    environment:
      name: homologation
      url: https://bug-inspector-homol-mcc.herokuapp.com
    steps:
      - name: Download Server Artifact
        uses: actions/download-artifact@v4
        with:
          name: bug-inspector-server
          path: ./server

      - name: Download Extension Artifact
        uses: actions/download-artifact@v4
        with:
          name: bug-inspector-extension
          path: ./src/dist

      - name: Deploy to Heroku Homologation
        run: |
          echo "Deploying to Heroku Homologation..."
          git remote add heroku-homol https://git.heroku.com/bug-inspector-homol-mcc.git || true
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git push heroku-homol HEAD:main --force
          echo "Homologation deployment complete!"
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}

  deploy_main:
    needs: build_and_test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://bug-inspector-prod-mcc.herokuapp.com
    steps:
      - name: Download Server Artifact
        uses: actions/download-artifact@v4
        with:
          name: bug-inspector-server
          path: ./server

      - name: Download Extension Artifact
        uses: actions/download-artifact@v4
        with:
          name: bug-inspector-extension
          path: ./src/dist

      - name: Deploy to Heroku Production
        run: |
          echo "Deploying to Heroku Production..."
          git remote add heroku-prod https://git.heroku.com/bug-inspector-prod-mcc.git || true
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git push heroku-prod HEAD:main --force
          echo "Production deployment complete!"
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}